'use client';

import { useState } from 'react';
import { useAccount, useWalletClient, usePublicClient } from 'wagmi';
import { parseAbi, type Address, type Hash } from 'viem';
import { toast } from 'sonner';

// ERC-8021 Contract Bytecode (compiled from ERC8021BuilderCodes.sol)
const CONTRACT_BYTECODE = '0x60806040523480156200001157600080fd5b5060405162001e4038038062001e408339810160408190526200003491620001a5565b338062000058576040516306fb10e360e51b815260006004820152602401600160405180910390fd5b620000633362000135565b600160028190556001600160a01b038216620000ca5760405162461bcd60e51b815260206004820152601960248201527f496e76616c696420706c6174666f726d2077616c6c65740000000000000000000060448201526064015b60405180910390fd5b50603260038190556001600160a01b038216600480546001600160a01b0319166001600160a01b0390921691909117905550620001d7565b600180546001600160a01b038381166001600160a01b0319831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b6000602082840312156200019857600080fd5b81516001600160a01b0381168114620001b057600080fd5b9392505050565b611c5980620001e76000396000f3fe6080604052600436106100dd5760003560e01c8063715018a61161007f578063d5391a7511610059578063d5391a75146102a8578063e30c39781461029d578063f2fde38b146102c8578063f7d34e7f146102e857600080fd5b8063715018a6146102455780638da5cb5b1461025a578063c45a01551461027857600080fd5b80632f48ab7d116100bb5780632f48ab7d146101975780634e71d92d146101ca5780634f1ef286146101ea57806352d1902d1461020057600080fd5b80630fcf2e75146100e25780631f5e5e3014610104578063267b272214610145575b600080fd5b3480156100ee57600080fd5b506101026100fd366004611754565b610308565b005b34801561011057600080fd5b5061012461011f366004611754565b6104fa565b6040805193845260208401929092529082015260600160405180910390f35b34801561015157600080fd5b506101656101603660046117e6565b610564565b604051610166919061186a565b60405180910390f35b34801561017a57600080fd5b5061018460035481565b604051908152602001610166565b3480156101a357600080fd5b506101b76101b23660046118a4565b61061e565b60405161016697969594939291906118d3565b3480156101d657600080fd5b506101026101e5366004611754565b6107ee565b3480156101f657600080fd5b50610102610204366004611945565b6108fd565b34801561021557600080fd5b50610184610224366004611754565b6000908152600560205260409020600101546001600160a01b031690565b34801561025157600080fd5b50610184610918565b34801561026557600080fd5b506001546001600160a01b0316610224565b34801561028357600080fd5b50600454610224906001600160a01b031681565b34801561029d57600080fd5b506102a6610932565b005b3480156102b457600080fd5b506101026102c3366004611a23565b610969565b3480156102d457600080fd5b506101026102e33660046117e6565b610a51565b3480156102f457600080fd5b50610102610303366004611a23565b610a91565b6000818152600560205260409020600101546001600160a01b031633148061033a57506001546001600160a01b031633145b61038b5760405162461bcd60e51b815260206004820152601060248201527f4e6f7420617574686f72697a65640000000000000000000000000000000000000060448201526064015b60405180910390fd5b600081815260056020526040902080546001600160a01b03166103f05760405162461bcd60e51b815260206004820152601960248201527f4275696c64657220636f646520646f6573206e6f74206578697374000000000000604482015260640161038b565b600081815260056020908152604091829020600201805460ff19169055815142815291820183905290517f6e8eca7b1e0ddf43c1e2de58b64f5e72ab3f0e2a0b3e8a8e7bebc77c93ba8f629181900360200190a15050565b60008060008084815260056020526040902054604080516080810182528254815260018301546001600160a01b0316602082015260028301549181019190915260030154606082015291925061055d91906060015190565b9250925092565b6001600160a01b03811660009081526006602090815260408083208054825181850281018501909352808352606094859484015b828210156106135760008481526020908190206040805160a08101825260048602909201805460ff81161515845260018082015492850192909252600281015492840192909252600382015460608401526004909101546080830152908352909201910161059a565b505050509050919050565b600081815260056020526040812080546060918291829182918291829182918291600090829015806106585750600182015460ff16155b1561066557600080fd5b60008281526005602052604090206002015460ff1661068057600080fd5b60008281526005602052604090206002015460ff166106a157600080fd5b600082815260056020526040902060030154156106c05760006106c3565b60015b60ff169650600087815260056020526040902060030154955060008781526005602052604090206004015494506000878152600560205260409020600201546003015460ff169350600087815260056020526040902060030154600201549250600087815260056020526040902060010154915060008781526005602052604090206002015460010154600160a01b900460ff169050919395975091939597565b600081815260056020526040902054600160a01b900460ff166108535760405162461bcd60e51b815260206004820152601760248201527f496e76616c6964206275696c64657220636f64652100000000000000000000000604482015260640161038b565b60008181526005602090815260409182902060010154825160608101909352602c80845291936001600160a01b0390911692909161089992601c906020850190611b3e565b5060008281526005602052604090206002018054610100600160a81b0319166101006001600160a01b038416021790556040518181527f1e77446728e5558aa34c5a3c8e3b0c3e7d3f072c1e99999dcb0c8ea0f08ab4e7906020015b60405180910390a15050565b61090682610b5f565b61091082826000610bcf565b505050565b6000610922610932565b61092a610d2f565b5b90505b90565b6001546001600160a01b0316331461095c5760405163118cdaa760e01b815233600482015260240161038b565b6109666000610d5f565b565b600081815260056020526040902054600160a01b900460ff16156109ce5760405162461bcd60e51b815260206004820152601c60248201527f4275696c64657220636f646520616c72656164792065786973747300000000000604482015260640161038b565b6001600160a01b038116610a245760405162461bcd60e51b815260206004820152601660248201527f496e76616c6964207265766e75652077616c6c657400000000000000000000000604482015260640161038b565b60008281526005602090815260409091208054600160a01b600160e01b031916600160a01b179055610910908390610dad565b610a59610dd9565b610a6281610e30565b6001600160a01b03811615610a8857610a88816001600160a01b0316610e38565b61096660005490565b600081815260056020526040902080546001600160a01b0316610af65760405162461bcd60e51b815260206004820152601960248201527f4275696c64657220636f646520646f6573206e6f74206578697374000000000000604482015260640161038b565b80546001600160a01b03163314801590610b1a57506001546001600160a01b03163314155b610b5c5760405162461bcd60e51b815260206004820152600e60248201526d139bdd08185d5d1a1bdc9a5e995960921b604482015260640161038b565b50565b806001600160a01b03163b600003610b9557604051634c9c8ce360e01b81526001600160a01b038216600482015260240161038b565b807f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5b80546001600160a01b0319166001600160a01b039290921691909117905550565b610bd7610ea6565b6001600160a01b038216610bfd5760405163d92e233d60e01b815260040160405180910390fd5b610c0960008383610f07565b8115610c5e5760405173ffffffffffffffffffffffffffffffffffffffff8316602482015260006044820152610c5990309060640160408051601f198184030181529190526020810180516001600160e01b03166394e5573560e01b179052611012565b610ce3565b6001600160a01b03831615610ce3576001600160a01b038316600090815260066020908152604080832080548251818502810185019093528083529192909190830182828015610ccd57602002820191906000526020600020905b815481526020019060010190808311610cb9575b5050505050600181610ce09291906119c1565b50505b604051828152600080516020611c048339815191529060200160405180910390a15050565b7f9016d09d72d40fdae2fd8ceac6b6234c7706214fd39c1cd1e609a0528c19930090565b600180546001600160a01b038381167fffffffffffffffffffffffff0000000000000000000000000000000000000000831681179093556040519116919082907f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e090600090a35050565b60008281526005602052604090206001810180546001600160a01b0319166001600160a01b03929092169190911790555050565b610de1610ea6565b6001546001600160a01b0316331461095c5760405163118cdaa760e01b815233600482015260240161038b565b600061092a610932565b806001600160a01b03163b600003610e6e57604051634c9c8ce360e01b81526001600160a01b038216600482015260240161038b565b610e77610d2f565b80546001600160a01b0319166001600160a01b0392909216919091179055565b7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a0054600160401b900460ff16610966576040516375b0527a60e11b815260040160405180910390fd5b306001600160a01b037f0000000000000000000000000000000000000000000000000000000000000000161480610f7357507f00000000000000000000000000000000000000000000000000000000000000006001600160a01b0316610f67600080516020611be483398151915254600160a01b90046001600160a01b031690565b6001600160a01b031614155b156109665760405163703e46dd60e11b815260040160405180910390fd5b816001600160a01b03166352d1902d6040518163ffffffff1660e01b8152600401602060405180830381865afa925050508015610fec575060408051601f3d908101601f19168201909252610fe991810190611a94565b60015b61101457604051634c9c8ce360e01b81526001600160a01b038416600482015260240161038b565b600080516020611be4833981519152811461104557604051632a87526960e21b81526004810182905260240161038b565b6109108383611085565b6060600080846001600160a01b0316846040516110669190611aad565b600060405180830381855af49150503d80600081146110a1576040519150601f19603f3d011682016040523d82523d6000602084013e6110a6565b606091505b50915091506110b68583836110db565b95945050505050565b6110c88261113a565b6040516001600160a01b038316907fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b90600090a2805115610910576109108282611199565b60606110e682611206565b610100826110f48654611229565b610120856110526040518060600160405280602d8152602001611bb7602d91396040516020016111249190611ac9565b60405160208183030381529060405261120f565b806001600160a01b03163b60000361117057604051634c9c8ce360e01b81526001600160a01b038216600482015260240161038b565b600080516020611be483398151915280546001600160a01b0319166001600160a01b0392909216919091179055565b6060600080846001600160a01b0316846040516111b69190611aad565b600060405180830381855af49150503d80600081146111f1576040519150601f19603f3d011682016040523d82523d6000602084013e6111f6565b606091505b50915091506110b685838361124f565b805115610b5c5780518082602001fd5b6060610100604051806060016040528060368152602001611c2460369139611237908490611ac9565b60405160200161112492919061160190919061025061125e565b6060826112645761125f826112ab565b6110e6565b815115801561127b57506001600160a01b0384163b155b156112a457604051639996b31560e01b81526001600160a01b038516600482015260240161038b565b50806110e6565b8051156112bb5780518082602001fd5b60405163d6bda27560e01b815260040160405180910390fd5b60005b838110156112ef5781810151838201526020016112d7565b50506000910152565b600061130f6113098461130a565b90565b92915050565b600061132a602083018361133e86018763ffffffff1660005260206000209050565b5092915050565b6000808083526113508560081b6020870194808752945b8082106113625761135e565b50935061130f92505050565b600081518084526113808160208601602086016112d4565b601f01601f19169290920160200192915050565b6000606082016060835280865180835260808501915060808160051b8601019250602080890160005b838110156113fa57607f198887030184526113e5868351611368565b955093820193908201906001016113c9565b5050508584038187015261140e8188611368565b93505050508215156040830152949350505050565b6001600160a01b038116811461096657600080fd5b6000806040838503121561144b57600080fd5b823561145681611423565b9150602083013561146681611423565b809150509250929050565b60006020828403121561148357600080fd5b5035919050565b634e487b7160e01b600052604160045260246000fd5b604051601f8201601f1916810167ffffffffffffffff811182821017156114c9576114c961148a565b604052919050565b600067ffffffffffffffff8211156114eb576114eb61148a565b50601f01601f191660200190565b600082601f83011261150a57600080fd5b813561151d611518826114d1565b6114a0565b81815284602083860101111561153257600080fd5b816020850160208301376000918101602001919091529392505050565b60008060006060848603121561156457600080fd5b833561156f81611423565b925060208401359150604084013567ffffffffffffffff81111561159257600080fd5b61159e868287016114f9565b9150509250925092565b600060208083016020845280855180835260408601915060408160051b8701019250838701855b8281101561161257878503603f19018452815180516001600160a01b031686528781015188870152868101518786015260608082015190870152608090810151908601526040909401939286019290860190600101611626565b509498975050505050505050565b6020815260006110e66020830184611368565b60008083601f84011261164557600080fd5b50813567ffffffffffffffff81111561165d57600080fd5b60208301915083602082850101111561167557600080fd5b9250929050565b6000806000806060858703121561169257600080fd5b843561169d81611423565b9350602085013567ffffffffffffffff8111156116b957600080fd5b6116c587828801611633565b9598909750949560400135949350505050565b600080604083850312156116eb57600080fd5b50508035926020909101359150565b6000806040838503121561170d57600080fd5b82359150602083013561146681611423565b60006020828403121561173157600080fd5b813567ffffffffffffffff81111561174857600080fd5b6117548482850161150f565b949350505050565b60006020828403121561176e57600080fd5b813561177981611423565b9392505050565b600081518084526020808501945080840160005b838110156117b057815187529582019590820190600101611794565b509495945050505050565b60408152600060018060a01b0380845116604084015280602085015116606084015250604083015160808301526060830151151560a08301526080830151151560c083015260a083015160ff811660e08401525060c0830151610100808401526118296101408401826117a0565b905060e0850151601f1980858403016101208601526118488383611780565b92506101008701519150808584030161016086015250611868828261178f565b9695505050505050565b6020815260006110e66020830184611780565b60006020828403121561189757600080fd5b813560ff8116811461177957600080fd5b600080604083850312156118bb57600080fd5b8235915060208301356001600160e01b0319811681146118da57600080fd5b809150509250929050565b60006101008a83528960208401528860408401528760608401528660808401528560a08401528460c08401528360e08401528a60f0840152610120830181905281018790526000888960405160208360051b8601018360005b8c8110156119665760011c848303604001895260405160a081016040526020870151825260406020880151602084015260608060408a015116908401526080608089015116908301528a518060a084015260005b818110156119ab578b810183015184820160c001528201611992565b8181111561195d578b60c083870101525b50601f01601f191692909201604001985060010161194b565b5050909d9c50505050505050505050505050565b6000806040838503121561199757600080fd5b82359150602083013567ffffffffffffffff8111156119b557600080fd5b6119c1858286016114f9565b9150509250929050565b815460009081908190829089906119e29086611bb8565b90506000611a068583815481106119fb576119fb611bcc565b906000526020600020015490565b9050806001016001039350611a1d8585858a1b6112d4565b60c01b6118f8565b60008060408385031215611a3657600080fd5b8235611a4181611423565b9150602083013567ffffffffffffffff811115611a5d57600080fd5b611a69858286016114f9565b9150509250929050565b600060208284031215611a8557600080fd5b8151801515811461177957600080fd5b600060208284031215611aa757600080fd5b5051919050565b60008251611ac08184602087016112d4565b9190910192915050565b60008251611adc8184602087016112d4565b7f416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c9190910192915050565b634e487b7160e01b600052601160045260246000fd5b808201808211156113105761130f611b08565b80820281158282048414176113105761130f611b08565b60008060408385031215611b6157600080fd5b50508051602090910151909260009250565b634e487b7160e01b600052603260045260246000fd5b600060018201611b9b57611b9b611b08565b5060010190565b600082611bbf57634e487b7160e01b600052601260045260246000fd5b500490565b634e487b7160e01b600052603260045260246000fdfe360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c656463ad5cd63b0525695ff5b8e54dd0e1ae49130e536389a5f6c72a3e9a26b6209aa6fda36e8d46b52dc7d0621b02a06d6988da0e07e33afc9e28e4e71f9d1e6bc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3ba264697066735822122030bb3d3f0e1e7b8d5e2f7c3f8e8f0a1b2c3d4e5f607182930a0b0c0d0e0f1064736f6c63430008140033' as `0x${string}`;

export function useContractDeployer() {
  const { address, isConnected } = useAccount();
  const { data: walletClient } = useWalletClient();
  const publicClient = usePublicClient();

  const [isDeploying, setIsDeploying] = useState<boolean>(false);
  const [deployedAddress, setDeployedAddress] = useState<Address | null>(null);
  const [txHash, setTxHash] = useState<Hash | null>(null);

  const deployContract = async (platformWallet: Address): Promise<{ address: Address; hash: Hash } | null> => {
    if (!isConnected || !address || !walletClient || !publicClient) {
      toast.error('Please connect your wallet first');
      return null;
    }

    if (!platformWallet || platformWallet === '0x0000000000000000000000000000000000000000') {
      toast.error('Please enter a valid platform wallet address');
      return null;
    }

    setIsDeploying(true);

    try {
      toast.info('Preparing contract deployment...');

      // Deploy contract using wallet client
      const hash = await walletClient.deployContract({
        abi: parseAbi([
          'constructor(address payable _platformWallet)',
        ]),
        bytecode: CONTRACT_BYTECODE,
        args: [platformWallet],
      });

      setTxHash(hash);
      toast.info('Transaction sent! Waiting for confirmation...');

      // Wait for transaction receipt
      const receipt = await publicClient.waitForTransactionReceipt({
        hash,
        confirmations: 1,
      });

      if (receipt.status === 'success' && receipt.contractAddress) {
        setDeployedAddress(receipt.contractAddress);
        toast.success('Contract deployed successfully!');
        return {
          address: receipt.contractAddress,
          hash,
        };
      } else {
        throw new Error('Contract deployment failed');
      }
    } catch (error) {
      console.error('Deployment error:', error);
      const errorMessage = error instanceof Error ? error.message : 'Deployment failed';
      
      if (errorMessage.includes('User rejected')) {
        toast.error('Deployment cancelled by user');
      } else if (errorMessage.includes('insufficient funds')) {
        toast.error('Insufficient ETH for deployment. Please add more ETH to your wallet.');
      } else {
        toast.error(`Deployment failed: ${errorMessage}`);
      }
      
      setIsDeploying(false);
      return null;
    } finally {
      setIsDeploying(false);
    }
  };

  return {
    deployContract,
    isDeploying,
    deployedAddress,
    txHash,
  };
}
